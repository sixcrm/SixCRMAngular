general:
  branches:
    only:
      - staging
      - development
      - production

machine:
  timezone:
    America/Los_Angeles
  node:
    version: 7.6.0

dependencies:
  pre:
    - openssl aes-256-cbc -d -in ./deployment/config/aws.$CIRCLE_BRANCH.encrypted -k $SIX_SKELETON_KEY >> ~/.circlerc
    - aws configure set preview.cloudfront true
  post:
    - echo "$AWS_ACCOUNT $AWS_REGION $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY"

test:
  override:
    - "true"

deployment:
  production:
    branch: production
    commands:
      - node deployment/versioning.js
      - ./deployment/build.sh
      - node deployment/deploy-s3.js admin.sixcrm.com
      - node deployment/deploy-cloudfront.js admin.sixcrm.com

  staging:
    branch: staging
    commands:
      - node deployment/versioning.js
      - ./deployment/build.sh
      - node deployment/deploy-s3.js admin.sixcrm.com
      - node deployment/deploy-cloudfront.js admin.sixcrm.com
      - node ./deployment/merge-branches.js

  development:
    branch: development
    commands:
      # Set version
      - node deployment/versioning.js

      # Build Angular App
      - ./deployment/build.sh

      # Deploy App to S3
      - node deployment/deploy-s3.js admin.sixcrm.com

      # Add/Update CloudFront Distribution
      - node deployment/deploy-cloudfront.js admin.sixcrm.com

      # Run e2e tests before propagation
      - npm run e2e-full

      # Promote changes
      - node ./deployment/merge-branches.js
