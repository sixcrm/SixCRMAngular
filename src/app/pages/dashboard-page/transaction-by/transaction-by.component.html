<div inViewport (inside)="fetch()" class="dashboard__table-chart">
  <div class="dashboard__table-chart__title">
    <div class="dashboard__table-chart__title__main">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_TITLE' | translate}}</div>
    <div class="dashboard__table-chart__title__sub">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_SUBTITLE' | translate}}</div>
    <mat-icon [matMenuTriggerFor]="downloadOptions">more_vert</mat-icon>
    <mat-menu #downloadOptions="matMenu" x-position="before">
      <button md-menu-item (click)="download('json')">{{'CHART_DOWNLOADJSON' | translate}}</button>
      <button md-menu-item (click)="download('csv')">{{'CHART_DOWNLOADCSV' | translate}}</button>
      <button md-menu-item (click)="download('excel')">{{'CHART_DOWNLOADEXCEL' | translate}}</button>
    </mat-menu>
  </div>
  <server-error-message (refresh)="refreshData()" *ngIf="serverError; else data"></server-error-message>

  <ng-template #data>
    <chart *ngIf="transactionBy && transactionBy.count > 0; else transactionByNoData" #chart (load)="saveChart($event.context)" [options]="options"></chart>
    <chart *ngIf="!transactionBy" [options]="loaderOptions"></chart>

    <div *ngIf="transactionBy && transactionBy.count > 0" class="dashboard__table" [style.height]="calculateHeight()" [class.dashboard__table--inactive]="!showTable || !transactionBy">
      <table class="highlight">
        <thead>
        <tr>
          <th>{{'DASHBOARD_TRANSACTIONBYAFFILIATE_AFFILIATE' | translate}}</th>
          <th class="cell--align-right">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_COUNT' | translate}}</th>
          <th class="cell--align-right">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_COUNTP' | translate}}</th>
          <th class="cell--align-right">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_AMOUNT' | translate}}</th>
          <th class="cell--align-right">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_AMOUNTP' | translate}}</th>
        </tr>
        </thead>
        <tbody *ngIf="transactionBy">
        <tr *ngFor="let facet of transactionBy.facets | subArray: maxNumber + 2; let i = index" [routerLink]="['/affiliates', facet.facet]">
          <td><div [style.background]="colors[i]" class="color-indicator"></div>{{facet.facet.substring(0, 12) + '...'}}</td>
          <td class="cell--align-right">{{facet.count  | numberlocale}}</td>
          <td class="cell--align-right">{{facet.countPercentage | numberlocale}}%</td>
          <td class="cell--align-right">{{facet.amount.usd()}}</td>
          <td class="cell--align-right">{{facet.amountPercentage | numberlocale}}%</td>
        </tr>
        </tbody>
      </table>
    </div>

    <ng-template #transactionByNoData>
      <div *ngIf="transactionBy" class="dashboard__table-chart__no-data">{{'DASHBOARD_TRANSACTIONBYAFFILIATE_NODATA' | translate}}</div>
    </ng-template>

    <div class="dashboard__table-chart__actions dashboard__table-chart__actions--no-border">
      <span *ngIf="transactionBy && transactionBy.count > 0" (click)="toggleTable()">{{(showTable ? 'CHART_COLLAPSE' : 'CHART_SHOWTABLE') | translate}}</span>
      <span [routerLink]="['/coming-soon']">{{'CHART_VIEWMORE' | translate}}</span>
    </div>

  </ng-template>
</div>
