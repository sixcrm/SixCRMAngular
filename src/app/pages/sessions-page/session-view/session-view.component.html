<div class="entity-view__container" *ngIf="entity; else spinner">

  <div class="entity-view">
    <entity-view-breadcrumbs [items]="breadcrumbs"></entity-view-breadcrumbs>

    <div (click)="navigation.back()" class="entity-view__change-mode"><mat-icon>reply</mat-icon></div>

    <div class="entity-view__info">
      <div class="entity-view__info__image">
        <img src="/assets/images/result-item-transaction-white.svg" alt="">
      </div>
      <div class="entity-view__info__data">
        <div class="entity-view__info__data__date">{{'SINGLEPAGE_CREATED' | translate}}: {{entity.createdAt | formatDateTime: 'date-time'}}</div>
        <div class="entity-view__info__data__name">
          <span>{{entityBackup.alias || entityBackup.id}}</span>
        </div>
      </div>

      <div class="entity-view__info__edit">
        <div *ngIf="!entity.cancelled.cancelled; else cancelmessage" class="cancel">CANCEL</div>
        <ng-template #cancelmessage>
          <div class="cancelled-message">
            <div>Session cancelled</div>
            <div>by {{entity.cancelled.cancelledBy.name}} at {{entity.cancelled.cancelledAt.format('MM/DD/YY')}}</div>
          </div>
        </ng-template>
      </div>
    </div>

    <tab-header [elements]="tabHeaders" [selectedIndex]="selectedIndex" (select)="setIndex($event)"></tab-header>

    <mat-tab-group [(selectedIndex)]="selectedIndex">
      <mat-tab>
        <div class="flex-custom session-view__card-container">
            <div class="entity-view__card">
              <div class="entity-view__card__header">
                <div class="entity-view__card__header__title">{{'SESSION_CUSTOMER_TITLE' | translate}}</div>
                <mat-icon [matMenuTriggerFor]="actionsMenu">more_vert</mat-icon>
                <mat-menu #actionsMenu="matMenu" x-position="before">
                  <button mat-menu-item [routerLink]="['/customers', entity.customer.id]">{{'SESSION_CUSTOMER_VIEW' | translate}}</button>
                </mat-menu>
              </div>

              <div class="entity-view__card__content">
                <mat-input-container class="entity-view__card__content__item">
                  <input matInput disabled placeholder="{{'FORMINPUTS_FIRSTNAME' | translate}}" [(ngModel)]="entity.customer.firstName" type="text">
                </mat-input-container>

                <mat-input-container class="entity-view__card__content__item">
                  <input matInput disabled placeholder="{{'FORMINPUTS_LASTNAME' | translate}}" [(ngModel)]="entity.customer.lastName" type="text">
                </mat-input-container>

                <mat-input-container class="entity-view__card__content__item">
                  <input matInput disabled placeholder="{{'FORMINPUTS_ADDRESS' | translate}}" [(ngModel)]="entity.customer.address.line1" type="text">
                </mat-input-container>

                <mat-input-container class="entity-view__card__content__item">
                  <input matInput disabled placeholder="{{'FORMINPUTS_CITY' | translate}}" [(ngModel)]="entity.customer.address.city" type="text">
                </mat-input-container>

                <div class="flex-custom">
                  <dropdown-component class="session-view__item--left" [placeholder]="'FORMINPUTS_STATE' | translate" [disabled]="true" [selected]="entity.customer.address.state"></dropdown-component>

                  <mat-input-container class="entity-view__card__content__item session-view__item--right">
                    <input matInput disabled placeholder="{{'FORMINPUTS_ZIP' | translate}}" [(ngModel)]="entity.customer.address.zip" type="text">
                  </mat-input-container>
                </div>

                <dropdown-component [placeholder]="'FORMINPUTS_COUNTRY' | translate" [disabled]="true" [selected]="entity.customer.address.country"></dropdown-component>
              </div>
            </div>

            <div class="flex-custom flex-custom--wrap">
              <table-memory class="session-view__table"
                            [data]="entity.rebills"
                            [filterEnabled]="false"
                            [textOptions]="rebillText"
                            [columnParams]="rebillColumnParams"
                            [associationEnabled]="false"
                            [dissociationEnabled]="false"
                            (view)="viewRebill($event)">
              </table-memory>

              <table-memory class="session-view__table"
                            [data]="[entity.campaign]"
                            [filterEnabled]="false"
                            [textOptions]="campaignText"
                            [columnParams]="campaignColumnParams"
                            [associationEnabled]="false"
                            [dissociationEnabled]="false"
                            (view)="viewCampaign($event)">
              </table-memory>
            </div>
          </div>
      </mat-tab>

      <mat-tab>
        <schedules-detailed
          [productSchedules]="entity.watermark.extractedProductSchedules"
          [products]="entity.watermark.extractedProducts"
          [startDate]="entity.startedAt"
          (productSchedulesChanged)="updateItems($event)"
          [statusMessage]="updateError ? 'Error occured on save' : productSchedulesWaitingForUpdate ? 'Saving...' : 'All changes saved'"
          (detailsComponent)="setDetails($event)">
        </schedules-detailed>
      </mat-tab>

      <mat-tab>
        <table-memory [data]="affiliates"
                      [textOptions]="affiliateText"
                      [filterEnabled]="false"
                      [columnParams]="affiliateColumnParams"
                      [associationEnabled]="false"
                      [dissociationEnabled]="false"
                      (view)="viewAffiliate($event)">
        </table-memory>
      </mat-tab>
    </mat-tab-group>
  </div>

  <div class="details-container" [class.details-container--hidden]="selectedIndex !== 1">
    <ng-container *ngTemplateOutlet="detailsElement"></ng-container>
  </div>

</div>

<ng-template #spinner>
  <spe-loader [numberOfTabs]="3" [numberOfCards]="3" [title]="'SESSION_INDEX_TITLE' | translate"></spe-loader>
</ng-template>


